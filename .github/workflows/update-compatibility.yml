name: Update SDK Compatibility Table

on:
  workflow_dispatch:
    inputs:
      VERSION:
        required: true
      BRANCH:
        required: true
  repository_dispatch:
    types: [ compatibility-table-update ]
env:
  VERSION: ${{ github.event.client_payload.version }}
  BRANCH: ${{ github.event.client_payload.branch }}

concurrency: compatibility_table_update

jobs:
  update:
    name: Update Table
    runs-on: ubuntu-18.04
    steps:
    - name: Check out code
      uses: actions/checkout@v2
      with:
        token: ${{ secrets.PAKETO_BOT_GITHUB_TOKEN }}

    - name: Set Env Vars
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_ENV
          echo "BRANCH=${{ github.event.inputs.branch }}" >> $GITHUB_ENV
        fi

    - name: Checkout Branch
      uses: paketo-buildpacks/github-config/actions/pull-request/checkout-branch@main
      with:
        branch: ${{ env.BRANCH }}

    - name: Update the table
      id: update
      uses: paketo-buildpacks/dotnet-core-sdk/actions/compatibility@main
      with:
        buildpack_file: "/github/workspace/buildpack.toml"
        sdk_version: ${{ env.VERSION }}
        output_dir: "/github/workspace"

    - name: Commit
      id: commit
      uses: paketo-buildpacks/github-config/actions/pull-request/create-commit@main
      with:
        message: "Updating buildpack.toml compatibility table for SDK v${{ env.VERSION }}"
        pathspec: "."
        keyid: ${{ secrets.PAKETO_BOT_GPG_SIGNING_KEY_ID }}
        key: ${{ secrets.PAKETO_BOT_GPG_SIGNING_KEY }}

    - name: Push Branch
      if: ${{ steps.commit.outputs.commit_sha != '' }}
      uses: paketo-buildpacks/github-config/actions/pull-request/push-branch@main
      with:
        branch: ${{ env.BRANCH }}

    - name: Open Pull Request
      if: ${{ steps.commit.outputs.commit_sha != '' }}
      uses: paketo-buildpacks/github-config/actions/pull-request/open@main
      with:
        title: "Updating buildpack.toml SDK compatibility table"
        branch: ${{ env.BRANCH }}
        token: ${{ secrets.PAKETO_BOT_GITHUB_TOKEN }}
